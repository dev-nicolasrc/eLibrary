language: python
python:
  - "3.12"

services:
  - docker
  - mysql

env:
  global:
    - DB_HOST=127.0.0.1
    - DB_NAME=biblioteca
    - DB_USER=usuario
    - DB_PASSWORD=usuario123
    - MYSQL_DATABASE=biblioteca
    - MYSQL_USER=usuario
    - MYSQL_PASSWORD=usuario123
    - MYSQL_ROOT_PASSWORD=root123

before_install:
  # Esperar a que MySQL est√© listo
  - |
    for i in {30..0}; do
      if mysql -h 127.0.0.1 -e "select 1" > /dev/null 2>&1; then
        break
      fi
      echo "Esperando MySQL... ($i/30)"
      sleep 1
    done
    if [ "$i" = 0 ]; then
      echo "‚ùå MySQL no respondi√≥ a tiempo"
      exit 1
    fi
  
  # Crear base de datos y usuario
  - mysql -h 127.0.0.1 -u root -e "CREATE DATABASE IF NOT EXISTS biblioteca;"
  - mysql -h 127.0.0.1 -u root -e "CREATE USER 'usuario'@'localhost' IDENTIFIED BY 'usuario123';" || true
  - mysql -h 127.0.0.1 -u root -e "GRANT ALL PRIVILEGES ON biblioteca.* TO 'usuario'@'localhost';"
  - mysql -h 127.0.0.1 -u root -e "FLUSH PRIVILEGES;"
  - echo "‚úÖ Base de datos configurada"

  # Actualizar pip
  - pip install --upgrade pip

install:
  # Instalar dependencias desde requirements.txt
  - cd biblioteca_virtua
  - echo "üì¶ Instalando dependencias..."
  - pip install -r requirements.txt
  - cd ..
  - echo "‚úÖ Dependencias instaladas"

before_script:
  # Ejecutar migraciones
  - cd biblioteca_virtua
  - echo "üîÑ Ejecutando migraciones..."
  - python manage.py migrate
  - echo "‚úÖ Migraciones completadas"

script:
  # Ejecutar pruebas unitarias
  - echo "üß™ Ejecutando pruebas unitarias..."
  - python run_unit_tests.py
  - echo "‚úÖ Pruebas completadas"
  
  # Generar reporte de cobertura
  - echo "üìä Generando reporte de cobertura..."
  - coverage run --source=libros,usuarios,prestamos,core run_unit_tests.py
  - coverage report -m
  - coverage xml
  - echo "‚úÖ Cobertura generada"

after_success:
  # Enviar reporte de cobertura a Codecov
  - pip install codecov
  - codecov
  - echo "‚úÖ Reporte enviado a Codecov"

on_failure:
  - echo "‚ùå El pipeline fall√≥"
  - echo "Ver logs arriba para m√°s detalles"

notifications:
  email:
    on_success: change
    on_failure: always
  slack:
    # Opcional: configura tu webhook de Slack
    # rooms:
    #   - your-slack-webhook
    # on_success: change
    # on_failure: always

cache: pip

