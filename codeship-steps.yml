- name: Verificar Salud
  service: codeship_app
  command: echo "ğŸš€ Pipeline de Codeship iniciado"

- name: Instalar Dependencias
  service: codeship_app
  command: |
    echo "ğŸ“¦ Instalando dependencias..."
    cd /app/biblioteca_virtua
    pip install --upgrade pip
    pip install -r requirements.txt
    echo "âœ… Dependencias instaladas"

- name: Esperar BD
  service: codeship_app
  command: |
    echo "â³ Esperando a que MySQL estÃ© listo..."
    for i in {60..0}; do
      if python -c "import MySQLdb; MySQLdb.connect(host='codeship_db', user='usuario', passwd='usuario123', db='biblioteca')" > /dev/null 2>&1; then
        echo "âœ… MySQL estÃ¡ listo"
        break
      fi
      echo "  Intento $((60-i))/60..."
      sleep 1
    done
    if [ "$i" = 0 ]; then
      echo "âŒ MySQL no respondiÃ³"
      exit 1
    fi

- name: Migraciones
  service: codeship_app
  command: |
    echo "ğŸ”„ Ejecutando migraciones..."
    cd /app/biblioteca_virtua
    python manage.py migrate
    echo "âœ… Migraciones completadas"

- name: Pruebas Unitarias
  service: codeship_app
  command: |
    echo "ğŸ§ª Ejecutando pruebas unitarias..."
    cd /app/biblioteca_virtua
    python run_unit_tests.py
    echo "âœ… Pruebas completadas"

- name: Reporte de Cobertura
  service: codeship_app
  command: |
    echo "ğŸ“Š Generando reporte de cobertura..."
    cd /app/biblioteca_virtua
    coverage run --source=libros,usuarios,prestamos,core run_unit_tests.py
    coverage report -m
    coverage xml
    echo "âœ… Cobertura generada"

- name: Enviar Cobertura
  service: codeship_app
  command: |
    echo "ğŸ“¤ Enviando reporte de cobertura..."
    pip install codecov
    codecov || echo "âš ï¸  Codecov no disponible"
    echo "âœ… Reporte enviado"
